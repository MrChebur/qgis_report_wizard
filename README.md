# QGIS report wizard

The plugin makes use of python templating libraries for creating reports from data within current QGIS project in the following formats:

- ODT
- Markdown

## python dependencies

- [jinja2](https://jinja.palletsprojects.com/en/3.0.x/)  usually bundled with QGIS distribution or `pip install jinja2` if not provided
- [secretary](https://github.com/christopher-ramirez/secretary)  bundled with plugin as external library

## jinja2 template syntax

The template engine parses text document and injects contents from a provided data environment following instructions contained in  of template tags: 

- double curly braces for variables: `{{ variable }}`
- curly brace and percent for statements: `{% statement %}`
- curly brace and hash for comments `{# comment #}`

#### variables

Structured variables can be accessed with a dot syntax like objects: `{{ variable.key.subkey }}` but can be accessed with the usual python dictionary syntax:  `{{ variable["key"]["subkey"] }}`

#### filters

Variables can be modified by filters. `{{ variable|filter(arguments) }}` The filter is basically a function that accept a variable as input and modify its contents following the provided arguments

There are standard filters, provided by base Jinjia2 installation, and custom templates, added by jinjia2 based applications

#### statements

The statements tags define blocks of text that can be conditionally rendered or iterated or asssume a certain meaning for the template engine, for example for escaping/encoding or defining functional blocks. The main statement tags are

**the conditional tag:**

```django
{% if condition1 %} 
block of text to be rendered if condition1 is true
{% elif condition2 %} 
block of text to be rendered if condition2 is true
{% else %}
block of text to be rendered if condition1 and condition2 are false
{% endif %}
```

within `if/endif` tags `elif` and `else` tags are optional 

**the for cycle tag:**

```
{% for item in list %}
block of text to be repeated for each item: {{ item }} in list
{% endfor %}
```

the cycle statement typically iterate over a list variable but can be used to iterate over a dictionary  object:

```
{% for key,value in dictionary.items() %}
block of text to be repeated for each dictionary item {{ value }}
accessible by {{ key }} key
{% endfor %}
```

Complex, data driven, documents can be generated mixing and nesting conditional and cycle statements with context variables and static text. Templating is typically is used in dynamyc html page generation in python web application (django, flask, etc) but can be used in QGIS desktop environment to generate "project" driven complex documents and reports, enriched with data related geographic frames generated by the powerful QGIS rendering engine.

## the plugin template environment

The plugin provides to the template engine a jinja2 data environment containing most relevant tabular and geographic informations about current project like variables, bookmarks, themes, print layouts, layers and vector features whenever specified. Those informations are stored in four variables that can be used in template:

- **globals**: information about project and current visualization on map canvas
- **layers**: information about loaded layers
- **features**: attributes and geometries about a specified vector layer
- **layouts**: information about defined print layouts

## the global variable

A dictionary variable containing general informations

| key           | meaning                                                      | tag syntax                                                   |
| ------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| project       | the project object instance. <br />Further information can be retrieved <br />calling [QgsProject API methods](https://qgis.org/pyqgis/master/core/QgsProject.html) | `{{ globals.project }}`<br />`{{ globals.project.crs() }}`<br />`{{ globals.project.title() }}`<br /> |
| mapCanvas     | the current map canvas object instance. <br />Further information can be retrieved <br />calling [QgsMapProject API methods](https://qgis.org/pyqgis/master/gui/QgsMapCanvas.html?) | `{{ globals.mapCanvas }}`<br />`{{ globals.mapCanvas.extent() }}`<br />`{{ globals.mapCanvas.scale() }}`<br /> |
| bbox          | A list containing the current vieport extent [min_x,min_y,max_x, max_y] (list) | `{{ globals.bbox }}`<br />                                   |
| vector_driver | The reference to the specified vector layer that drives the features object rendering, or `None` in not specified (QgsVectorLayer) | `{{ globals.vector_driver }}`<br />`{% if globals.vector_driver %}{{ globals.vector_driver.name() }}{% endif %}` |
| vars          | A dictionary containing the current project/user/system defined variables (dictionary) | `{{ globals.vars }}`<br />`{% for key,value in global.vars.items()%} {{ key }}: {{ value }} {% endfor %}`<br /> |
| bookmarks     | A dictionary containing the extents of the current user/project defined bookmarks (QgsRectangle objects) | {`{ globals.bookmarks }}`<br />`{% for key,value in global.bookmarks.items()%} {{ key }}: {{ value.xMinimum() }} {% endfor %}`<br /> |
| themes        | A list of the current map canvas themes names (string)       | `{{ globals.themes }}`<br />`{% for theme in global.themes %} {{ theme }} {% endfor %}`<br /> |

....... 